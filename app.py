import streamlit as st
import groq
import pandas as pd
import io
import json
import re
from datetime import datetime, timedelta
import base64

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="ü§ñ Agente S√™nior - Arquitetura de Sistemas",
    page_icon="üöÄ",
    layout="wide"
)

# T√≠tulo principal
st.title("ü§ñ Agente S√™nior - Arquitetura de Sistemas")
st.markdown("**Sistema especialista em desenvolvimento de software**")

# üîë **SISTEMA DE CHAVE SEGURO**
st.sidebar.header("üîë Configura√ß√£o da Chave Groq")

# Op√ß√£o 1: Input direto (mais seguro)
groq_api_key = st.sidebar.text_input(
    "Sua chave Groq:",
    value="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",
    type="password",
    help="Chave j√° pr√©-configurada. Mantenha em segredo!"
)

# Op√ß√£o 2: Verificar se a chave funciona
if groq_api_key:
    try:
        # Teste r√°pido da chave
        client = groq.Client(api_key=groq_api_key)
        test_response = client.chat.completions.create(
            model="mixtral-8x7b-32768",
            messages=[{"role": "user", "content": "Diga apenas 'OK' se funcionar."}],
            max_tokens=5
        )
        st.sidebar.success("‚úÖ Chave Groq configurada e funcionando!")
    except Exception as e:
        st.sidebar.error("‚ùå Chave inv√°lida. Verifique a chave Groq.")

# Sistema de estado da sess√£o
if 'conversation' not in st.session_state:
    st.session_state.conversation = []
if 'project_data' not in st.session_state:
    st.session_state.project_data = {}
if 'current_step' not in st.session_state:
    st.session_state.current_step = "initial"
if 'excel_data' not in st.session_state:
    st.session_state.excel_data = None

class AdvancedSystemArchitect:
    def __init__(self, groq_api_key):
        self.client = groq.Client(api_key=groq_api_key)
    
    def analyze_excel_file(self, uploaded_file):
        """Analisa arquivo Excel e extrai requisitos"""
        try:
            df = pd.read_excel(uploaded_file)
            analysis = {
                'columns': list(df.columns),
                'rows': len(df),
                'sample_data': df.head(3).to_dict('records'),
                'data_types': df.dtypes.to_dict()
            }
            return analysis
        except Exception as e:
            return {'error': str(e)}
    
    def generate_technical_scope(self, conversation_history, excel_analysis=None):
        """Gera escopo t√©cnico baseado na conversa e Excel"""
        
        # Construir contexto da conversa
        context = "CONVERSA COM CLIENTE:\n"
        for msg in conversation_history:
            context += f"{msg['role'].upper()}: {msg['content']}\n"
        
        if excel_analysis and 'error' not in excel_analysis:
            context += f"\nDADOS DO EXCEL:\n{json.dumps(excel_analysis, indent=2)}"
        
        prompt = f"""
        Como Arquiteto de Software S√™nior (20+ anos de experi√™ncia), analise os requisitos e gere um escopo t√©cnico completo.

        {context}

        FORMATO DA RESPOSTA:

        # üéØ VIS√ÉO DO SISTEMA
        [Descri√ß√£o clara dos objetivos e valor do sistema]

        # üèóÔ∏è ARQUITETURA T√âCNICA
        ## Stack Recomendada
        - Frontend: [tecnologias espec√≠ficas]
        - Backend: [tecnologias espec√≠ficas] 
        - Banco de Dados: [solu√ß√µes recomendadas]
        - Infraestrutura: [cloud, deployment]

        ## Componentes Principais
        [Lista dos m√≥dulos do sistema]

        # üìã FUNCIONALIDADES PRINCIPAIS
        [Lista detalhada das features priorizadas]

        # ‚ö†Ô∏è CONSIDERA√á√ïES T√âCNICAS
        [Riscos, melhores pr√°ticas, custos estimados]
        """
        
        try:
            response = self.client.chat.completions.create(
                model="mixtral-8x7b-32768",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                max_tokens=3000
            )
            
            return response.choices[0].message.content
                
        except Exception as e:
            return f"Erro na gera√ß√£o do escopo: {str(e)}"
    
    def generate_roadmap(self, scope_content, complexity="medium"):
        """Gera roadmap baseado no escopo"""
        timelines = {"low": 4, "medium": 8, "high": 12}
        weeks = timelines.get(complexity, 8)
        
        prompt = f"""
        Com base neste escopo t√©cnico:

        {scope_content}

        Gere um roadmap de desenvolvimento para {weeks} semanas com fases realistas e tarefas espec√≠ficas.

        FORMATO:
        FASE 1: [Nome] ({weeks//4} semanas)
        - Tarefa 1
        - Tarefa 2

        FASE 2: [Nome] ({weeks//4} semanas)  
        - Tarefa 1
        - Tarefa 2
        """
        
        try:
            response = self.client.chat.completions.create(
                model="mixtral-8x7b-32768",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                max_tokens=2000
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"Roadmap padr√£o: {weeks} semanas divididas em {weeks//4} fases"

    def chat_with_architect(self, conversation_history, user_message):
        """Conversa interativa com o arquiteto"""
        
        # Construir hist√≥rico de conversa
        messages = []
        for msg in conversation_history[-6:]:  # √öltimas 6 mensagens
            messages.append({"role": msg["role"], "content": msg["content"]})
        
        messages.append({"role": "user", "content": user_message})
        
        try:
            response = self.client.chat.completions.create(
                model="mixtral-8x7b-32768",
                messages=messages,
                temperature=0.7,
                max_tokens=1000
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"Desculpe, erro na conversa: {str(e)}"

# Interface principal
def main():
    # Verificar se a chave est√° configurada
    if not groq_api_key:
        st.error("üîë Configure a chave Groq na barra lateral")
        return

    # Abas principais
    tab1, tab2, tab3, tab4 = st.tabs(["üí¨ Conversa", "üìä Excel", "üìã Escopo", "üóìÔ∏è Roadmap"])
    
    with tab1:
        st.header("üí¨ Conversa com o Arquiteto")
        
        # Inicializar conversa
        if st.session_state.current_step == "initial":
            st.session_state.conversation.append({
                "role": "assistant",
                "content": "üëã Ol√°! Sou seu Arquiteto de Sistemas S√™nior. Para criar o melhor escopo t√©cnico, vou fazer algumas perguntas.\n\n**Vamos come√ßar? Me conte:**\n‚Ä¢ Qual o objetivo principal do sistema?\n‚Ä¢ Quem ser√£o os usu√°rios?\n‚Ä¢ Quais funcionalidades s√£o essenciais?"
            })
            st.session_state.current_step = "gathering_requirements"
        
        # Exibir hist√≥rico da conversa
        for msg in st.session_state.conversation:
            with st.chat_message(msg["role"]):
                st.write(msg["content"])
        
        # Input do usu√°rio
        if prompt := st.chat_input("Digite sua resposta ou fa√ßa uma pergunta..."):
            # Adicionar mensagem do usu√°rio
            st.session_state.conversation.append({"role": "user", "content": prompt})
            
            # Gerar resposta do assistente
            with st.spinner("ü§ñ Analisando e respondendo..."):
                architect = AdvancedSystemArchitect(groq_api_key)
                assistant_response = architect.chat_with_architect(
                    st.session_state.conversation, 
                    prompt
                )
                
                st.session_state.conversation.append({
                    "role": "assistant", 
                    "content": assistant_response
                })
                
                st.rerun()
    
    with tab2:
        st.header("üìä Upload de Arquivo Excel")
        
        uploaded_file = st.file_uploader(
            "Carregue uma planilha com requisitos:",
            type=['xlsx', 'xls'],
            help="Excel com funcionalidades, usu√°rios, prioridades etc."
        )
        
        if uploaded_file:
            architect = AdvancedSystemArchitect(groq_api_key)
            analysis = architect.analyze_excel_file(uploaded_file)
            st.session_state.excel_data = analysis
            
            if 'error' not in analysis:
                st.success("‚úÖ Arquivo analisado com sucesso!")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.subheader("üìã Estrutura do Arquivo")
                    st.write(f"**Colunas:** {', '.join(analysis['columns'])}")
                    st.write(f"**Linhas:** {analysis['rows']}")
                
                with col2:
                    st.subheader("üìä Amostra de Dados")
                    if analysis['sample_data']:
                        st.json(analysis['sample_data'][:2])
            else:
                st.error(f"‚ùå Erro na an√°lise: {analysis['error']}")
    
    with tab3:
        st.header("üìã Gerar Escopo T√©cnico")
        
        if len(st.session_state.conversation) > 1:
            if st.button("üèóÔ∏è Gerar Escopo T√©cnico Completo", type="primary"):
                with st.spinner("Criando escopo t√©cnico detalhado..."):
                    architect = AdvancedSystemArchitect(groq_api_key)
                    
                    scope_content = architect.generate_technical_scope(
                        st.session_state.conversation,
                        st.session_state.excel_data
                    )
                    
                    st.session_state.project_data['scope'] = scope_content
                    
                    st.success("‚úÖ Escopo t√©cnico gerado!")
                    st.markdown(scope_content)
        else:
            st.info("üí° Primeiro converse com o arquiteto na aba 'Conversa'")
    
    with tab4:
        st.header("üóìÔ∏è Gerar Roadmap")
        
        if st.session_state.project_data.get('scope'):
            complexity = st.selectbox(
                "Complexidade do projeto:",
                ["low", "medium", "high"],
                format_func=lambda x: {"low": "Baixa", "medium": "M√©dia", "high": "Alta"}[x]
            )
            
            if st.button("üìÖ Gerar Roadmap", type="primary"):
                with st.spinner("Criando roadmap de desenvolvimento..."):
                    architect = AdvancedSystemArchitect(groq_api_key)
                    
                    roadmap_content = architect.generate_roadmap(
                        st.session_state.project_data['scope'],
                        complexity
                    )
                    
                    st.session_state.project_data['roadmap'] = roadmap_content
                    st.success("‚úÖ Roadmap gerado!")
                    st.markdown(roadmap_content)
        else:
            st.info("üëÜ Gere primeiro o escopo t√©cnico na aba anterior")

if __name__ == "__main__":
    main()
