import streamlit as st
import groq
import pandas as pd
import json
from datetime import datetime
import base64

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="ü§ñ Agente S√™nior - Arquitetura de Sistemas",
    page_icon="üöÄ",
    layout="wide"
)

st.title("ü§ñ Agente S√™nior - Arquitetura de Sistemas")
st.markdown("**Sistema especialista em desenvolvimento de software**")

# üîë CHAVE GROQ INTEGRADA DIRETAMENTE
GROQ_API_KEY = "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"

# Modelos dispon√≠veis no Groq
AVAILABLE_MODELS = [
    "llama-3.1-8b-instant",  # Modelo mais r√°pido
    "llama-3.1-70b-versatile",  # Modelo mais inteligente
    "mixtral-8x7b-32768"  # Tentar mesmo assim
]

SELECTED_MODEL = "llama-3.1-70b-versatile"  # Modelo padr√£o

# Sistema de estado
if 'conversation' not in st.session_state:
    st.session_state.conversation = []
if 'excel_data' not in st.session_state:
    st.session_state.excel_data = None
if 'project_scope' not in st.session_state:
    st.session_state.project_scope = None
if 'current_model' not in st.session_state:
    st.session_state.current_model = SELECTED_MODEL

# Classe do arquiteto
class SystemArchitect:
    def __init__(self, api_key):
        self.client = groq.Client(api_key=api_key)
        self.model = st.session_state.current_model
    
    def try_models(self, message, history):
        """Tenta diferentes modelos at√© encontrar um que funcione"""
        models_to_try = ["llama-3.1-70b-versatile", "llama-3.1-8b-instant", "mixtral-8x7b-32768"]
        
        for model in models_to_try:
            try:
                messages = []
                for msg in history[-6:]:
                    messages.append({"role": msg["role"], "content": msg["content"]})
                messages.append({"role": "user", "content": message})
                
                response = self.client.chat.completions.create(
                    model=model,
                    messages=messages,
                    temperature=0.7,
                    max_tokens=1500
                )
                st.session_state.current_model = model
                return response.choices[0].message.content
            except Exception as e:
                continue
        
        return "‚ùå Erro: Nenhum modelo dispon√≠vel funcionou. Tente novamente mais tarde."
    
    def chat(self, message, history):
        try:
            messages = []
            for msg in history[-6:]:
                messages.append({"role": msg["role"], "content": msg["content"]})
            messages.append({"role": "user", "content": message})
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=1500
            )
            return response.choices[0].message.content
        except Exception as e:
            # Se der erro, tenta outros modelos
            return self.try_models(message, history)
    
    def generate_technical_scope(self, requirements):
        """Gera escopo t√©cnico completo"""
        prompt = f"""
        Como Arquiteto de Software S√™nior com 20+ anos de experi√™ncia, 
        analise estes requisitos e gere um escopo t√©cnico completo:
        
        REQUISITOS: {requirements}
        
        FORMATO DA RESPOSTA:
        
        # üéØ VIS√ÉO DO SISTEMA
        [Descri√ß√£o clara dos objetivos]
        
        # üèóÔ∏è ARQUITETURA T√âCNICA
        ## Stack Recomendada
        - Frontend: [tecnologias espec√≠ficas]
        - Backend: [tecnologias espec√≠ficas]
        - Banco de Dados: [solu√ß√µes recomendadas]
        - Infraestrutura: [cloud, deployment]
        
        ## Componentes Principais
        [Lista dos m√≥dulos do sistema]
        
        # üìã FUNCIONALIDADES
        [Lista detalhada das features]
        
        # ‚ö†Ô∏è CONSIDERA√á√ïES T√âCNICAS
        [Riscos, melhores pr√°ticas, custos estimados]
        """
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                max_tokens=3000
            )
            return response.choices[0].message.content
        except Exception as e:
            # Tenta com outro modelo
            try:
                response = self.client.chat.completions.create(
                    model="llama-3.1-8b-instant",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.7,
                    max_tokens=3000
                )
                st.session_state.current_model = "llama-3.1-8b-instant"
                return response.choices[0].message.content
            except Exception as e2:
                return f"Escopo t√©cnico b√°sico baseado nos requisitos fornecidos. Sistema personalizado com arquitetura moderna."

    def generate_roadmap(self, scope_content):
        """Gera roadmap baseado no escopo"""
        prompt = f"""
        Com base neste escopo t√©cnico, crie um roadmap realista de desenvolvimento:
        
        {scope_content}
        
        FORMATO:
        
        # üóìÔ∏è ROADMAP DE DESENVOLVIMENTO
        
        ## Fase 1: Planejamento e Setup (1-2 semanas)
        - [ ] Defini√ß√£o de requisitos detalhados
        - [ ] Setup do ambiente de desenvolvimento
        - [ ] Arquitetura t√©cnica inicial
        
        ## Fase 2: Desenvolvimento Core (3-4 semanas)  
        - [ ] Implementa√ß√£o das funcionalidades principais
        - [ ] Desenvolvimento do backend
        - [ ] Desenvolvimento do frontend
        
        ## Fase 3: Integra√ß√£o e Testes (1-2 semanas)
        - [ ] Integra√ß√£o dos componentes
        - [ ] Testes de qualidade
        - [ ] Corre√ß√µes e ajustes
        
        ## Fase 4: Deploy e Valida√ß√£o (1 semana)
        - [ ] Deploy em produ√ß√£o
        - [ ] Valida√ß√£o com usu√°rios
        - [ ] Documenta√ß√£o final
        """
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                max_tokens=2000
            )
            return response.choices[0].message.content
        except Exception as e:
            return """# üóìÔ∏è ROADMAP DE DESENVOLVIMENTO

## Fase 1: Planejamento (1-2 semanas)
- Defini√ß√£o de requisitos detalhados
- Setup do ambiente de desenvolvimento
- Arquitetura t√©cnica inicial

## Fase 2: Desenvolvimento (3-4 semanas)
- Implementa√ß√£o das funcionalidades core
- Desenvolvimento do backend e frontend
- Integra√ß√µes b√°sicas

## Fase 3: Testes (1-2 semanas)
- Testes de qualidade
- Corre√ß√µes e otimiza√ß√µes
- Prepara√ß√£o para deploy

## Fase 4: Deploy (1 semana)
- Deploy em produ√ß√£o
- Valida√ß√£o final
- Documenta√ß√£o"""

    def analyze_excel_data(self, df):
        """Analisa dados do Excel e extrai insights"""
        analysis = {
            'columns': list(df.columns),
            'rows': len(df),
            'sample_data': df.head(3).to_dict('records')
        }
        
        prompt = f"""
        Analise estes dados de Excel e sugira requisitos t√©cnicos:
        
        DADOS: {json.dumps(analysis, indent=2)}
        
        Forne√ßa insights sobre:
        - Tipo de sistema sugerido pelos dados
        - Funcionalidades impl√≠citas
        - Considera√ß√µes t√©cnicas
        """
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                max_tokens=1500
            )
            return response.choices[0].message.content
        except Exception as e:
            return f"An√°lise b√°sica: {len(df)} linhas com {len(df.columns)} colunas. Dados estruturados para sistema empresarial."

# Interface principal
def main():
    # Verificar conex√£o
    try:
        architect = SystemArchitect(GROQ_API_KEY)
        # Teste com modelo atual
        test_response = architect.client.chat.completions.create(
            model=st.session_state.current_model,
            messages=[{"role": "user", "content": "OK"}],
            max_tokens=5
        )
        st.sidebar.success(f"‚úÖ Conectado - Modelo: {st.session_state.current_model}")
    except Exception as e:
        # Tentar com modelo alternativo
        try:
            architect = SystemArchitect(GROQ_API_KEY)
            test_response = architect.client.chat.completions.create(
                model="llama-3.1-8b-instant",
                messages=[{"role": "user", "content": "OK"}],
                max_tokens=5
            )
            st.session_state.current_model = "llama-3.1-8b-instant"
            st.sidebar.success(f"‚úÖ Conectado - Modelo: {st.session_state.current_model}")
        except Exception as e2:
            st.error(f"‚ùå Erro de conex√£o: {str(e2)}")
            st.info("""
            **Solu√ß√£o:**
            - A Groq atualizou seus modelos
            - Aguarde alguns minutos e tente novamente
            - Ou visite: https://console.groq.com/docs/models
            """)
            return
    
    # Abas principais
    tab1, tab2, tab3, tab4 = st.tabs(["üí¨ Conversa", "üìä Excel", "üìã Escopo", "üóìÔ∏è Roadmap"])
    
    with tab1:
        st.header("üí¨ Conversa com o Arquiteto")
        
        # Iniciar conversa
        if not st.session_state.conversation:
            st.session_state.conversation.append({
                "role": "assistant",
                "content": f"üëã Ol√°! Sou seu Arquiteto de Sistemas S√™nior (Modelo: {st.session_state.current_model}).\n\n**Vamos criar o escopo do seu sistema? Me conte:**\n‚Ä¢ Qual o objetivo principal?\n‚Ä¢ Quem ser√£o os usu√°rios?\n‚Ä¢ Quais funcionalidades s√£o essenciais?\n‚Ä¢ H√° alguma restri√ß√£o t√©cnica ou de prazo?"
            })
        
        # Mostrar hist√≥rico
        for msg in st.session_state.conversation:
            with st.chat_message(msg["role"]):
                st.write(msg["content"])
        
        # Input do usu√°rio
        if user_input := st.chat_input("Digite sua mensagem..."):
            # Adicionar mensagem do usu√°rio
            st.session_state.conversation.append({"role": "user", "content": user_input})
            
            # Gerar resposta
            with st.spinner("ü§ñ Analisando e respondendo..."):
                architect = SystemArchitect(GROQ_API_KEY)
                response = architect.chat(user_input, st.session_state.conversation)
                st.session_state.conversation.append({"role": "assistant", "content": response})
            
            st.rerun()
    
    with tab2:
        st.header("üìä Upload de Arquivo Excel")
        
        uploaded_file = st.file_uploader(
            "Carregue uma planilha com requisitos do sistema:",
            type=['xlsx', 'xls'],
            help="Excel com funcionalidades, usu√°rios, processos etc."
        )
        
        if uploaded_file:
            try:
                df = pd.read_excel(uploaded_file)
                st.success(f"‚úÖ Arquivo carregado: {len(df)} linhas, {len(df.columns)} colunas")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.subheader("üìã Estrutura do Arquivo")
                    st.write(f"**Colunas:** {', '.join(df.columns)}")
                    st.write(f"**Total de registros:** {len(df)}")
                    
                    # Analisar com IA
                    if st.button("üîç Analisar com IA", type="primary"):
                        with st.spinner("Analisando dados..."):
                            architect = SystemArchitect(GROQ_API_KEY)
                            analysis = architect.analyze_excel_data(df)
                            st.session_state.excel_data = analysis
                
                with col2:
                    st.subheader("üìä Amostra de Dados")
                    st.dataframe(df.head(3))
                
                # Mostrar an√°lise se existir
                if st.session_state.excel_data:
                    st.subheader("üí° Insights da An√°lise")
                    st.write(st.session_state.excel_data)
                        
            except Exception as e:
                st.error(f"‚ùå Erro ao ler arquivo: {str(e)}")
    
    with tab3:
        st.header("üìã Gerar Escopo T√©cnico")
        
        if len(st.session_state.conversation) > 1:
            # Extrair requisitos da conversa
            requirements = "\n".join([f"{msg['role']}: {msg['content']}" for msg in st.session_state.conversation])
            
            col1, col2 = st.columns([3, 1])
            
            with col1:
                if st.button("üèóÔ∏è Gerar Escopo T√©cnico Completo", type="primary", use_container_width=True):
                    with st.spinner("Criando escopo t√©cnico detalhado..."):
                        architect = SystemArchitect(GROQ_API_KEY)
                        scope = architect.generate_technical_scope(requirements)
                        st.session_state.project_scope = scope
            
            with col2:
                if st.session_state.project_scope:
                    # Download do escopo
                    b64 = base64.b64encode(st.session_state.project_scope.encode()).decode()
                    href = f'<a href="data:text/plain;base64,{b64}" download="escopo_tecnico.txt" style="background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">üì• Baixar Escopo</a>'
                    st.markdown(href, unsafe_allow_html=True)
            
            # Mostrar escopo se existir
            if st.session_state.project_scope:
                st.subheader("üéØ Escopo T√©cnico Gerado")
                st.markdown(st.session_state.project_scope)
        else:
            st.info("üí° Primeiro converse com o arquiteto para definir os requisitos do sistema")
    
    with tab4:
        st.header("üóìÔ∏è Gerar Roadmap")
        
        if st.session_state.project_scope:
            if st.button("üìÖ Gerar Roadmap de Desenvolvimento", type="primary"):
                with st.spinner("Criando roadmap..."):
                    architect = SystemArchitect(GROQ_API_KEY)
                    roadmap = architect.generate_roadmap(st.session_state.project_scope)
                    
                    st.subheader("üóìÔ∏è Roadmap de Desenvolvimento")
                    st.markdown(roadmap)
                    
                    # Download do roadmap
                    b64 = base64.b64encode(roadmap.encode()).decode()
                    href = f'<a href="data:text/plain;base64,{b64}" download="roadmap.txt" style="background-color: #2196F3; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">üì• Baixar Roadmap</a>'
                    st.markdown(href, unsafe_allow_html=True)
        else:
            st.info("üëÜ Gere primeiro o escopo t√©cnico na aba anterior")

if __name__ == "__main__":
    main()
